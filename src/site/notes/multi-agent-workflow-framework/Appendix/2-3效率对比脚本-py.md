---
{"dg-publish":true,"permalink":"/multi-agent-workflow-framework/appendix/2-3-py/","noteIcon":""}
---


```python
"""
2.3 äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”æ‰§è¡Œè„šæœ¬
åŠŸèƒ½ï¼šæŒ‰å­äº§å“ç»´åº¦åˆ†ææµ‹è¯•å‘¨æœŸã€è½¬åŒ–ç‡ã€æµå¤±ç‡ç­‰æ•ˆèƒ½æŒ‡æ ‡ï¼Œå¹¶è¾“å‡ºExcelã€Markdownå’Œå›¾ç‰‡
"""

import os
from datetime import datetime

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# è®¾ç½®ä¸­æ–‡æ˜¾ç¤º
plt.rcParams["font.sans-serif"] = ["SimHei"]
plt.rcParams["axes.unicode_minus"] = False

# é…ç½®
INPUT_FILE = "è„±æ•æ•°æ®_ç‰¹å¾å¢å¼º.xlsx"
OUTPUT_DIR = "æ‰§è¡Œåˆ†æç»“æœ/2.3_äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”"
OUTPUT_EXCEL = "2.3_äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”.xlsx"
OUTPUT_MD = "2.3_äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”æ‘˜è¦.md"
OUTPUT_PNG_RANK = "2.3_äº§å“æ•ˆèƒ½æ’å.png"
OUTPUT_PNG_COMPARE = "2.3_äº§å“æ•ˆèƒ½å¯¹æ¯”.png"


def main():
    # 1. è¯»å–æ•°æ®
    base_dir = os.path.dirname(os.path.dirname(__file__))
    input_path = os.path.join(base_dir, INPUT_FILE)

    if not os.path.exists(input_path):
        raise FileNotFoundError(f"æœªæ‰¾åˆ°è¾“å…¥æ–‡ä»¶ï¼š{input_path}")

    df = pd.read_excel(input_path)
    print(f"æ•°æ®è¯»å–æˆåŠŸ: {len(df)} è¡Œ, {len(df.columns)} åˆ—")

    # åˆ›å»ºè¾“å‡ºç›®å½•
    output_dir_abs = os.path.join(base_dir, OUTPUT_DIR)
    os.makedirs(output_dir_abs, exist_ok=True)
    excel_path = os.path.join(output_dir_abs, OUTPUT_EXCEL)
    md_path = os.path.join(output_dir_abs, OUTPUT_MD)
    png_rank_path = os.path.join(output_dir_abs, OUTPUT_PNG_RANK)
    png_compare_path = os.path.join(output_dir_abs, OUTPUT_PNG_COMPARE)

    # å¿…è¦å­—æ®µæ£€æŸ¥
    required_cols = [
        "å­äº§å“åç§°",
        "æµ‹è¯•å‘¨æœŸï¼ˆå¤©ï¼‰",
        "æ˜¯å¦å·²æ¥å…¥",
        "æ˜¯å¦è°ƒç”¨ï¼ˆæ•°å€¼ï¼‰",
        "æ˜¯å¦ä¸æ¥å…¥",
        "ä¸æ¥å…¥åŸå› ",
    ]
    missing = [c for c in required_cols if c not in df.columns]
    if missing:
        raise ValueError(f"è¾“å…¥æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µ: {missing}")

    # =========================
    # 1. äº§å“åŸºç¡€æ•ˆèƒ½æ’å
    # =========================
    print("\nè®¡ç®—äº§å“åŸºç¡€æ•ˆèƒ½æ’å...")

    # è®°å½•æ€»æ•°
    product_total = df.groupby("å­äº§å“åç§°").size().rename("è®°å½•æ€»æ•°")

    # æµ‹è¯•å‘¨æœŸç»Ÿè®¡
    cycle_stats = df.groupby("å­äº§å“åç§°")["æµ‹è¯•å‘¨æœŸï¼ˆå¤©ï¼‰"].agg(
        å¹³å‡æµ‹è¯•å‘¨æœŸ="mean",
        ä¸­ä½æ•°æµ‹è¯•å‘¨æœŸ="median",
        æ ‡å‡†å·®æµ‹è¯•å‘¨æœŸ="std",
    )

    # æ•°é‡ç»Ÿè®¡
    agg_counts = df.groupby("å­äº§å“åç§°").agg(
        å·²æ¥å…¥æ•°é‡=("æ˜¯å¦å·²æ¥å…¥", "sum"),
        å·²è°ƒç”¨æ•°é‡=("æ˜¯å¦è°ƒç”¨ï¼ˆæ•°å€¼ï¼‰", "sum"),
        ä¸æ¥å…¥æ•°é‡=("æ˜¯å¦ä¸æ¥å…¥", "sum"),
    )

    product_stats = pd.concat([product_total, cycle_stats, agg_counts], axis=1)

    # è®¡ç®—è½¬åŒ–ç‡å’Œæµå¤±ç‡
    product_stats["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"] = (
        np.where(
            product_stats["è®°å½•æ€»æ•°"] > 0,
            product_stats["å·²æ¥å…¥æ•°é‡"] / product_stats["è®°å½•æ€»æ•°"] * 100,
            np.nan,
        )
    ).round(2)
    product_stats["ç”³è¯·â†’å·²è°ƒç”¨è½¬åŒ–ç‡(%)"] = (
        np.where(
            product_stats["è®°å½•æ€»æ•°"] > 0,
            product_stats["å·²è°ƒç”¨æ•°é‡"] / product_stats["è®°å½•æ€»æ•°"] * 100,
            np.nan,
        )
    ).round(2)
    product_stats["ä¸æ¥å…¥æµå¤±ç‡(%)"] = (
        np.where(
            product_stats["è®°å½•æ€»æ•°"] > 0,
            product_stats["ä¸æ¥å…¥æ•°é‡"] / product_stats["è®°å½•æ€»æ•°"] * 100,
            np.nan,
        )
    ).round(2)

    # ç»¼åˆæ•ˆèƒ½å¾—åˆ†ï¼ˆæŒ‰è½¬åŒ–ç‡æ’åï¼‰
    valid_conv = product_stats["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"].fillna(0)
    product_stats["è½¬åŒ–ç‡å¾—åˆ†"] = valid_conv.rank(pct=True) * 100
    product_stats["ç»¼åˆæ•ˆèƒ½å¾—åˆ†"] = product_stats["è½¬åŒ–ç‡å¾—åˆ†"].round(2)
    product_stats["ç»¼åˆæ•ˆèƒ½æ’å"] = (
        product_stats["ç»¼åˆæ•ˆèƒ½å¾—åˆ†"].rank(ascending=False, method="min").astype(int)
    )

    product_stats = product_stats.sort_values("ç»¼åˆæ•ˆèƒ½æ’å")

    # =========================
    # 2. äº§å“ä¸æ¥å…¥åŸå› åˆ†å¸ƒ
    # =========================
    print("è®¡ç®—äº§å“ä¸æ¥å…¥åŸå› åˆ†å¸ƒ...")

    if df["ä¸æ¥å…¥åŸå› "].notna().any():
        tmp = df[df["ä¸æ¥å…¥åŸå› "].notna()]
        product_reason = (
            tmp.groupby("å­äº§å“åç§°")["ä¸æ¥å…¥åŸå› "]
            .value_counts()
            .unstack(fill_value=0)
        )
        reason_size = tmp.groupby("å­äº§å“åç§°").size()
        product_reason_pct = (
            product_reason.div(reason_size, axis=0).fillna(0) * 100
        ).round(2)
    else:
        product_reason = pd.DataFrame()
        product_reason_pct = pd.DataFrame()

    # =========================
    # 3. é«˜æ•ˆäº§å“ä¸ä½æ•ˆäº§å“
    # =========================
    print("è¯†åˆ«é«˜æ•ˆäº§å“ä¸ä½æ•ˆäº§å“...")

    stats_for_rank = product_stats.dropna(subset=["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"]).copy()
    if len(stats_for_rank) >= 2:
        top_products = (
            stats_for_rank.sort_values("ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)", ascending=False)
            .head(2)
            .index.tolist()
        )
        bottom_products = (
            stats_for_rank.sort_values("ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)", ascending=True)
            .head(2)
            .index.tolist()
        )
    else:
        top_products = stats_for_rank.index.tolist()
        bottom_products = stats_for_rank.index.tolist()

    def build_product_feature_dict(name: str) -> dict:
        sub = df[df["å­äº§å“åç§°"] == name]
        if name not in product_stats.index:
            return {}
        row = product_stats.loc[name]
        return {
            "è®°å½•æ€»æ•°": int(row["è®°å½•æ€»æ•°"]),
            "è½¬åŒ–ç‡": float(row["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"])
            if pd.notna(row["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"])
            else np.nan,
            "å¹³å‡æµ‹è¯•å‘¨æœŸ": float(row["å¹³å‡æµ‹è¯•å‘¨æœŸ"])
            if pd.notna(row["å¹³å‡æµ‹è¯•å‘¨æœŸ"])
            else np.nan,
            "æµå¤±ç‡": float(row["ä¸æ¥å…¥æµå¤±ç‡(%)"])
            if pd.notna(row["ä¸æ¥å…¥æµå¤±ç‡(%)"])
            else np.nan,
        }

    top_product_features = {
        p: build_product_feature_dict(p) for p in top_products
    }
    bottom_product_features = {
        p: build_product_feature_dict(p) for p in bottom_products
    }

    # =========================
    # 4. ä¿å­˜ Excel
    # =========================
    print(f"\nä¿å­˜Excelæ–‡ä»¶: {excel_path}")
    with pd.ExcelWriter(excel_path, engine="openpyxl") as writer:
        product_stats.to_excel(writer, sheet_name="äº§å“åŸºç¡€æ•ˆèƒ½æ’å")
        if not product_reason.empty:
            product_reason.to_excel(writer, sheet_name="äº§å“ä¸æ¥å…¥åŸå› åˆ†å¸ƒ")
            product_reason_pct.to_excel(writer, sheet_name="äº§å“ä¸æ¥å…¥åŸå› å æ¯”")

    print("Excelæ–‡ä»¶ä¿å­˜æˆåŠŸ")

    # =========================
    # 5. ç”Ÿæˆå›¾ç‰‡
    # =========================
    print(f"\nç”Ÿæˆå›¾ç‰‡...")

    # 5.1 äº§å“æ•ˆèƒ½æ’åå›¾
    if not product_stats.empty:
        products_for_plot = (
            product_stats.sort_values("ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)", ascending=False).head(
                20
            )
        )
        plt.figure(figsize=(12, 6))
        plt.bar(
            range(len(products_for_plot)),
            products_for_plot["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"],
            color="steelblue",
        )
        plt.xticks(
            range(len(products_for_plot)),
            products_for_plot.index,
            rotation=45,
            ha="right",
        )
        plt.ylabel("ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)")
        plt.title("2.3 äº§å“æ•ˆèƒ½æ’åï¼ˆæŒ‰ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡ï¼‰")
        plt.tight_layout()
        plt.savefig(png_rank_path, dpi=300, bbox_inches="tight")
        plt.close()
        print(f"äº§å“æ•ˆèƒ½æ’åå›¾å·²ä¿å­˜: {png_rank_path}")

    # 5.2 é«˜æ•ˆvsä½æ•ˆäº§å“å¯¹æ¯”å›¾
    names_for_compare = list(dict.fromkeys(top_products + bottom_products))
    if names_for_compare and len(names_for_compare) > 0:
        metrics = [
            "ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)",
            "å¹³å‡æµ‹è¯•å‘¨æœŸ",
            "ä¸æ¥å…¥æµå¤±ç‡(%)",
        ]
        comp_df = product_stats.loc[names_for_compare, metrics].copy()

        x = np.arange(len(names_for_compare))
        width = 0.25

        plt.figure(figsize=(12, 6))
        for i, m in enumerate(metrics):
            plt.bar(
                x + (i - 1) * width,
                comp_df[m],
                width=width,
                label=m,
            )

        plt.xticks(x, [str(n) for n in names_for_compare], rotation=45, ha="right")
        plt.ylabel("æ•°å€¼")
        plt.title("2.3 é«˜æ•ˆ vs ä½æ•ˆäº§å“å¯¹æ¯”ï¼ˆè½¬åŒ–ç‡ / å‘¨æœŸ / æµå¤±ç‡ï¼‰")
        plt.legend()
        plt.tight_layout()
        plt.savefig(png_compare_path, dpi=300, bbox_inches="tight")
        plt.close()
        print(f"äº§å“æ•ˆèƒ½å¯¹æ¯”å›¾å·²ä¿å­˜: {png_compare_path}")

    # =========================
    # 6. ç”Ÿæˆ Markdown æ‘˜è¦
    # =========================
    print(f"\nç”ŸæˆMarkdownæ‘˜è¦: {md_path}")

    now_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    md_lines = []
    md_lines.append("# äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”æ‘˜è¦")
    md_lines.append("")
    md_lines.append(f"> **ç”Ÿæˆæ—¶é—´**: {now_str}  ")
    md_lines.append(f"> **æ•°æ®æ–‡ä»¶**: {INPUT_FILE}  ")
    md_lines.append(f"> **æ•°æ®é‡**: {len(df)} æ¡è®°å½•")
    md_lines.append("")
    md_lines.append("---")
    md_lines.append("")
    md_lines.append("## ğŸ“Š äº§å“åŸºç¡€æ•ˆèƒ½æ’åï¼ˆæŒ‰ç»¼åˆæ•ˆèƒ½å¾—åˆ†ï¼‰")
    md_lines.append("")
    md_lines.append(
        "| æ’å | å­äº§å“åç§° | è®°å½•æ€»æ•° | å¹³å‡æµ‹è¯•å‘¨æœŸ(å¤©) | ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%) | "
        "ç”³è¯·â†’å·²è°ƒç”¨è½¬åŒ–ç‡(%) | ä¸æ¥å…¥æµå¤±ç‡(%) | ç»¼åˆæ•ˆèƒ½å¾—åˆ† |"
    )
    md_lines.append(
        "|------|------------|----------|------------------|---------------------|"
        "---------------------|-----------------|--------------|"
    )

    for name, row in product_stats.iterrows():
        md_lines.append(
            f"| {int(row['ç»¼åˆæ•ˆèƒ½æ’å'])} | {name} | "
            f"{int(row['è®°å½•æ€»æ•°'])} | "
            f"{row['å¹³å‡æµ‹è¯•å‘¨æœŸ']:.1f} | "
            f"{row['ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)']:.2f} | "
            f"{row['ç”³è¯·â†’å·²è°ƒç”¨è½¬åŒ–ç‡(%)']:.2f} | "
            f"{row['ä¸æ¥å…¥æµå¤±ç‡(%)']:.2f} | "
            f"{row['ç»¼åˆæ•ˆèƒ½å¾—åˆ†']:.2f} |"
        )

    # é«˜æ•ˆäº§å“
    md_lines.append("")
    md_lines.append("---")
    md_lines.append("")
    md_lines.append("## ğŸ† é«˜æ•ˆäº§å“ç‰¹å¾ï¼ˆè½¬åŒ–ç‡ Top 2ï¼‰")
    md_lines.append("")

    for p in top_products:
        feat = top_product_features.get(p, {})
        if not feat:
            continue
        md_lines.append(f"### {p}")
        md_lines.append("")
        md_lines.append(f"- **è®°å½•æ€»æ•°**: {feat['è®°å½•æ€»æ•°']}")
        if not np.isnan(feat["è½¬åŒ–ç‡"]):
            md_lines.append(f"- **ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡**: {feat['è½¬åŒ–ç‡']:.2f}%")
        if not np.isnan(feat["å¹³å‡æµ‹è¯•å‘¨æœŸ"]):
            md_lines.append(f"- **å¹³å‡æµ‹è¯•å‘¨æœŸ**: {feat['å¹³å‡æµ‹è¯•å‘¨æœŸ']:.1f} å¤©")
        if not np.isnan(feat["æµå¤±ç‡"]):
            md_lines.append(f"- **ä¸æ¥å…¥æµå¤±ç‡**: {feat['æµå¤±ç‡']:.2f}%")
        md_lines.append("")

    # ä½æ•ˆäº§å“
    md_lines.append("")
    md_lines.append("---")
    md_lines.append("")
    md_lines.append("## âš ï¸ ä½æ•ˆäº§å“ç‰¹å¾ï¼ˆè½¬åŒ–ç‡ Bottom 2ï¼‰")
    md_lines.append("")

    for p in bottom_products:
        feat = bottom_product_features.get(p, {})
        if not feat:
            continue
        md_lines.append(f"### {p}")
        md_lines.append("")
        md_lines.append(f"- **è®°å½•æ€»æ•°**: {feat['è®°å½•æ€»æ•°']}")
        if not np.isnan(feat["è½¬åŒ–ç‡"]):
            md_lines.append(f"- **ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡**: {feat['è½¬åŒ–ç‡']:.2f}%")
        if not np.isnan(feat["å¹³å‡æµ‹è¯•å‘¨æœŸ"]):
            md_lines.append(f"- **å¹³å‡æµ‹è¯•å‘¨æœŸ**: {feat['å¹³å‡æµ‹è¯•å‘¨æœŸ']:.1f} å¤©")
        if not np.isnan(feat["æµå¤±ç‡"]):
            md_lines.append(f"- **ä¸æ¥å…¥æµå¤±ç‡**: {feat['æµå¤±ç‡']:.2f}%")
        md_lines.append("")

    # å…³é”®å‘ç°
    md_lines.append("")
    md_lines.append("---")
    md_lines.append("")
    md_lines.append("## ğŸ“ˆ å…³é”®å‘ç°")
    md_lines.append("")

    if not product_stats.empty:
        best = product_stats["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"].idxmax()
        worst = product_stats["ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)"].idxmin()
        md_lines.append(
            f"1. **è½¬åŒ–ç‡æœ€é«˜äº§å“**ï¼š{best} "
            f"ï¼ˆ{product_stats.loc[best, 'ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)']:.2f}%ï¼‰"
        )
        md_lines.append(
            f"2. **è½¬åŒ–ç‡æœ€ä½äº§å“**ï¼š{worst} "
            f"ï¼ˆ{product_stats.loc[worst, 'ç”³è¯·â†’å·²æ¥å…¥è½¬åŒ–ç‡(%)']:.2f}%ï¼‰"
        )
        md_lines.append(
            f"3. **å¹³å‡æµ‹è¯•å‘¨æœŸæœ€çŸ­äº§å“**ï¼š"
            f"{product_stats['å¹³å‡æµ‹è¯•å‘¨æœŸ'].idxmin()} "
            f"ï¼ˆ{product_stats['å¹³å‡æµ‹è¯•å‘¨æœŸ'].min():.1f} å¤©ï¼‰"
        )
        md_lines.append(
            f"4. **å¹³å‡æµ‹è¯•å‘¨æœŸæœ€é•¿äº§å“**ï¼š"
            f"{product_stats['å¹³å‡æµ‹è¯•å‘¨æœŸ'].idxmax()} "
            f"ï¼ˆ{product_stats['å¹³å‡æµ‹è¯•å‘¨æœŸ'].max():.1f} å¤©ï¼‰"
        )
        md_lines.append(
            f"5. **æµå¤±ç‡æœ€ä½äº§å“**ï¼š"
            f"{product_stats['ä¸æ¥å…¥æµå¤±ç‡(%)'].idxmin()} "
            f"ï¼ˆ{product_stats['ä¸æ¥å…¥æµå¤±ç‡(%)'].min():.2f}%ï¼‰"
        )
        md_lines.append(
            f"6. **æµå¤±ç‡æœ€é«˜äº§å“**ï¼š"
            f"{product_stats['ä¸æ¥å…¥æµå¤±ç‡(%)'].idxmax()} "
            f"ï¼ˆ{product_stats['ä¸æ¥å…¥æµå¤±ç‡(%)'].max():.2f}%ï¼‰"
        )

    md_lines.append("")
    md_lines.append("---")
    md_lines.append("")
    md_lines.append("*æœ¬æŠ¥å‘Šç”± 2.3_äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”.md æ–¹æ¡ˆè‡ªåŠ¨ç”Ÿæˆ*")

    with open(md_path, "w", encoding="utf-8") as f:
        f.write("\n".join(md_lines))

    print("Markdownæ‘˜è¦ç”ŸæˆæˆåŠŸ")
    print(f"\nâœ… äº§å“æµ‹è¯•æ•ˆç‡å¯¹æ¯”åˆ†æå®Œæˆï¼")
    print(f"   Excelæ–‡ä»¶: {excel_path}")
    print(f"   Markdownæ‘˜è¦: {md_path}")
    print(f"   äº§å“æ•ˆèƒ½æ’åå›¾: {png_rank_path}")
    print(f"   äº§å“æ•ˆèƒ½å¯¹æ¯”å›¾: {png_compare_path}")


if __name__ == "__main__":
    main()


```